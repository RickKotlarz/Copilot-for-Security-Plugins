# Author Rick Kotlarz ~ https://github.com/RickKotlarz/
# 2024-Dec-02

Descriptor:
  Name: GPT Based Mailbox Rule Analysis v4
  DisplayName: GPT Based Mailbox Parameters Analysis v4
  Description: This plugin reviews output previously called via KQL to show mailbox rules and the parameters values associated with those rules.

SkillGroups:
  - Format: GPT
    Skills:
      - Name: PerformGPTbasedMailboxParametersAnalysis
        DisplayName: Perform GPT Based Mailbox Parameters Analysis
        Description: Perform GPT Based Mailbox Parameters Analysis
        Inputs:
          - Name: dataToReview
            Description: Mailbox parameters output to review
            DefaultValue: null
            Required: false  
        Settings:
          ModelName: gpt-4o
          Template: |-
            Assume the role of an expert SOC Analyst specializing in threat hunting for email and mailbox-based attacks. You are tasked with analyzing mailbox rule activity, that may indicate compromise. A common adversary techniques involve creating new email rules that exfiltrates messages to an RSS feed folder or similar location as well as forwarding and deleting sensitive information. 
            
            Mailbox rule actions commonly used attackers include: 'RedirectToRecipients', 'ForwardAsAttachmentToRecipients', 'MoveToFolder'
            Mailbox rule actions less commonly used attackers include: 'CopyToFolder', 'PermanentDelete'
            Mailbox rule actions rarely used attackers include: 'SendSMSAlertToRecipients', 'StopProcessingRules'
            
            Mailbox operations commonly used attackers include:
              - 'Add-MailboxPermission' when 'FullAccess' or 'SendAs' permissiones are indicated
              - 'New-InboxRule' when it pertains to forwarding emails containing sensitive information
              - 'Set-InboxRule' when it contains suspicious conditions or actions
            
            Mailbox operations less commonly used attackers include:
              - 'Set-Mailbox' when attackers want to be stealthy and enable features like forwarding, archiving, or changing quota limits to facilitate exfiltration.
              - 'New-TransportRule' or 'Set-TransportRule' when attackers want to create transport rules to intercept or redirect emails organization-wide, especially in multi-user compromises.
            
            Mailbox operations rarely used attackers include: 
              - 'Add-MailboxFolderPermission' when 'Reviewer' permissiones are indicated
              - 'New-ManagementRoleAssignment' may be exploited to assign elevated roles to themselves or the attackers tools
            
            Your task is to analyze the provided output for potential compromise on a user-by-user basis. Keywords that may indicate a potential risk within the parameters JSON indicating keywords include 'RSS', 'alert', 'daemon', 'did you', 'hack', 'helpdesk', 'IT', 'link', 'mimecast', 'phish', 'scam', 'security', 'suspicious', 'password', 'secret', 'key', and 'token'. Focus on the mailbox operation and action configured and consider the type of behavior associated with threat actors. Additionally, consider any other keywords or patterns that may represent Indicators of Compromise (IoCs) based on current or evolving threats.
                        
              Deliverables:
              1. For each user, assess whether the analyzed actions are likely related to a user's mailbox being compromised.
              2. For each action analyzed, provide a risk confidence score using the following levels 'Low', 'Medium', 'High', 'Critical'.
              3. For each risk confidence score, offer a brief explanation for the assigned confidence score, citing specific keywords, patterns, or behaviors observed in the data.
              4. For each rule, provide a summary.
                        
            Example response format for each user:
            UserId: [User email address denoted as UserId]
            Risk Confidence Level: [Low/Medium/High/Critical]
            Reasoning: [Include identified patterns, matched keywords, or anomalous behaviors identified from the Operation and Paremeters JSON.]            
            Date, time, & mailbox operation: [Timestamps from TimeGenerated]
            Parameters Rule Summary: [Provide a summary of each rule identified within the parameters JSON field]
            Client IP: [IP address denoted as ClientIP_WithoutPort]
            
            Here is the output to analyze: {{dataToReview}}